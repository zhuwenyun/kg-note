
https://help.aliyun.com/zh/apsaramq-for-rocketmq/cloud-message-queue-rocketmq-5-x-series/developer-reference/ordered-messages-1?spm=5176.rocketmq.console-base_help.dexternal.6d877d10GjKzsp


顺序消息生命周期
- 初始化
消息被生产者构建并完成初始化，待发送到服务端的状态。
- 待消费
消息被发送到服务端，对消费者可见，等待消费者消费的状态。
- 消费中
消息被消费者获取，并按照消费者本地的业务逻辑进行处理的过程。
- 消费提交
消费者完成消费处理，并向服务端提交消费结果，服务端标记当前消息已经被处理（包括消费成功和失败）。
- 消息删除
按照消息保存机制滚动清理最早的消息数据，将消息从物理文件中删除。
::: dangers
1. 消息消费失败或消费超时，会触发服务端重试逻辑，重试消息属于新的消息，原消息的生命周期已结束。
2. 顺序消息消费失败进行消费重试时，为保障消息的顺序性，后续消息不可被消费，必须等待前面的消息消费完成后才能被处理。
:::


使用建议
::: dangers
1. 消息组尽可能打散，避免集中导致热点
一般建议的消息组设计会采用订单ID、用户ID作为顺序参考，即同一个终端用户的消息保证顺序，不同用户的消息无需保证顺序。
因此建议将业务以消息组粒度进行拆分，例如，将订单ID、用户ID作为消息组关键字，可实现同一终端用户的消息按照顺序处理，不同用户的消息无需保证顺序。
2. 串行消费，避免批量消费导致乱序
消息消费建议串行处理，避免一次消费多条消息，否则可能出现乱序情况。
例如：发送顺序为1->2->3->4，消费时批量消费，消费顺序为1->23（批量处理，失败）->23（重试处理）->4，此时可能由于消息3的失败导致消息2被重复处理，最后导致消息消费乱序。

:::

顺序消息的扩容如何实现？
新生成的订单 = 扩容后的新topic
旧的订单 = 原topic








云消息队列 RocketMQ 版顺序消息投递仅在重试次数限定范围内，即一条消息如果一直重试失败，超过最大重试次数后将不再重试，跳过这条消息消费，不会一直阻塞后续消息处理。
对于需要严格保证消费顺序的场景，请务必设置合理的重试次数，避免参数不合理导致消息乱序。


如何实现并发消费：消费者如何使用并发的多线程机制处理消息，以此提高消息处理效率？
1、批量拉取多条消息，缓存在本地队列
2、根据配置并发线程数，并行消费消息
3、如果消费失败，将其投递延迟队列重试，然后继续并发消费
4、负责长轮训拉取消息的xian